--- channels/chan_sip.c.old	2009-06-23 12:13:57.000000000 -0400
+++ channels/chan_sip.c	2009-06-23 11:26:25.000000000 -0400
@@ -1454,6 +1454,7 @@
 static void sip_send_all_registers(void);
 
 /*--- Parsing SIP requests and responses */
+static int check_cpd_results(struct sip_pvt *p, struct sip_request *req);
 static void append_date(struct sip_request *req);	/* Append date to SIP packet */
 static int determine_firstline_parts(struct sip_request *req);
 static const struct cfsubscription_types *find_subscription_type(enum subscriptiontype subtype);
@@ -4247,6 +4248,29 @@
 
 	return _default;
 }
+/*! \brief Check for a CPD-Result
+		This looks for a CPD-Result in the sip_request 
+		and throws a manager event if it finds one
+ */
+static int check_cpd_results(struct sip_pvt *p, struct sip_request *req) {
+	const char *cpdr = get_header(req, "CPD-Result");\
+	/* See if NetBorder had anything to say */
+	if (!(ast_strlen_zero(cpdr))) {
+		/* If so throw a manager event with the result */
+		char cpd_result[SIPBUFSIZE];
+		ast_copy_string(cpd_result, get_header(req, "CPD-Result"), sizeof(cpd_result));
+		manager_event(
+			EVENT_FLAG_SYSTEM, 
+			"CPD-Result", 
+			"ChannelDriver: SIP\r\nChannel: %s\r\nCallerIDName: %s\r\nUniqueid: %s\r\nResult: %s\r\n",
+			p->owner->name,
+			p->owner->cid.cid_name,
+			p->owner->uniqueid,
+			cpd_result
+		);
+	} 
+	return 0;
+}
 
 static const char *__get_header(const struct sip_request *req, const char *name, int *start)
 {
@@ -6964,6 +6988,7 @@
 	char tmp2[SIPBUFSIZE/2];
 	const char *l = NULL, *n = NULL;
 	const char *urioptions = "";
+	const char *netbordercpd = ";cpd=on";  /* string used to enable NetBorder's CPD */
 
 	if (ast_test_flag(&p->flags[0], SIP_USEREQPHONE)) {
 	 	const char *s = p->username;	/* being a string field, cannot be NULL */
@@ -7050,6 +7075,9 @@
 	if (p->options && !ast_strlen_zero(p->options->uri_options))
 		ast_build_string(&invite, &invite_max, ";%s", p->options->uri_options);
 	
+	/* Tell NetBorder to enable CPD */
+	ast_build_string(&invite, &invite_max, "%s", netbordercpd);
+	
 	ast_string_field_set(p, uri, invite_buf);
 
 	if (sipmethod == SIP_NOTIFY && !ast_strlen_zero(p->theirtag)) { 
@@ -12740,6 +12768,10 @@
 		gettag(req, "To", tag, sizeof(tag));
 		ast_string_field_set(p, theirtag, tag);
 	}
+
+	/* Check if NetBorder had anything to say */
+	check_cpd_results(p, req);
+
 	if (p->relatedpeer && p->method == SIP_OPTIONS) {
 		/* We don't really care what the response is, just that it replied back. 
 		   Well, as long as it's not a 100 response...  since we might
